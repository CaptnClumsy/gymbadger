<!DOCTYPE html>
<html>
  <head>
    <title>GymBadger</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-multiselect.css"/>
    <link rel="stylesheet" href="css/select2.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css"/>
    <link rel="stylesheet" href="css/datatables.min.css"/>
    <link rel="stylesheet" href="css/snazzy-info-window.min.css">
    <link rel="stylesheet" href="css/bootstrap-switch.min.css">
    <link rel="stylesheet" href="css/badgerstyle.css"/>
    
      
  </head>
  <body>

    <nav class="navbar navbar-expand-md navbar-static-top navbar-dark bg-primary badger-navbar">
      <a class="navbar-brand" href="/tos">
        <img src="/images/badger.png" width="48" height="48" class="d-inline-block" alt="">
        <span class="badger-navbar-title">GymBadger</span>
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse badger-list-row" id="navbarNavDropdown">
        <ul class="navbar-nav ml-auto">
          <li class="badger-authenticated" style="display: none;">
              <span id="badger-gold-percent" class="badger-navbar-label badger-percent badger-percent-small"></span>
          </li>
          <li class="nav-item nav-link">
            <select id="filterButton" class="badger-filtericon-hidden" multiple="multiple">
            </select>
          </li>
          <li class="nav-item nav-link">
            <select id="search" name="search" class="form-control"><option></option></select>
          </li>
          <li class="nav-item nav-link">
            <div class="badger-unauthenticated">
              <a href="/login" class="btn btn-primary badger-login-button"><i class="fa fa-facebook badger-login-icon"></i>Sign In</a>
            </div>
            <div class="badger-authenticated btn-group" style="display: none;">
                <button class="dropdown-toggle btn btn-primary badger-user-button" type="button" id="userMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="badger-user-container"><span id="user"></span></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right badger-user-menu" aria-labelledby="userMenuButton">
                    <li><a id="reports" class="dropdown-item badger-user-item" onclick="return showReports();">Reports</a></li>
                    <li><a id="logout" class="dropdown-item badger-user-item" onclick="return logout();">Logout</a></li>
                </ul>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    
    <div id="badger-container" class="container fill badger-container">
      <div id="map"></div>
    </div>

    <div class="modal fade" id="errorPage" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="errorPageTitle" class="modal-title"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="errorPageBody"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>   
    </div>
    </div>
    
    <div class="modal fade" id="advancedOptions" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header badger-opt-header">
            <h5 class="modal-title">Advanced Raid Options</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body badger-options-page-body">
            <div id="badger-opt-date" class="input-group date badger-opt-date"> 
              <input type="text" class="form-control badger-opt-date-text" placeholder="Date of the raid"> 
              <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            </div>
            <div id="badger-opt-time" class="input-group date badger-opt-item"> 
              <input type="text" class="form-control badger-opt-date-text" placeholder="Time of the raid"> 
              <span class="input-group-addon"><i class="fa fa-clock-o"></i></span>
            </div>
            <div class="badger-opt-item"><select id="poke-search" name="poke-search" class="form-control"><option></option></select></div>
            <div class="badger-opt-item"><input type="checkbox" id="caught-switch" name="caught"></div>
            <div class="modal-footer badger-opt-footer">
              <div class="badger-opt-item badger-opt-btn-div"><button id="badger-opt-save" class="btn btn-primary btn-sm">Save</button></div>
            </div>
          </div>    
        </div>
      </div>
    </div>

    <div class="modal fade" id="reportsPage" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Reports</h3>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body badger-report-page-body">
          <div>
            <p class="badger-rep-heading">Gym Progress</p>
            <div class="badger-rep-percent-area">
              <div>
                <div class="badger-rep-percent-title">Visited</div>
                <div><span id="badger-rep-visited-percent" class="badger-navbar-label badger-percent badger-percent-large-border"></span></div>
              </div>
              <div>
                <div class="badger-rep-percent-title">Gold</div>
                <div><span id="badger-rep-gold-percent" class="badger-navbar-label badger-percent badger-percent-large-border"></span></div>
              </div>
              <div>
                <div class="badger-rep-percent-title">Total</div>
                <div><span id="badger-rep-total-percent" class="badger-navbar-label badger-percent badger-percent-large"></span></div>
              </div>
            </div>
          </div>
          <div>
            <p class="badger-rep-heading">Gym List</p>
            <div class="badger-rep-table-container">
            <table id="reportsTable" class="table table-striped table-bordered badger-report-table" style="width: 100%;">
            <thead>
              <tr>
                <th>Gym</th>
                <th>Badge</th>
                <th>Area</th>
                <th>Park</th>
                <th>Raided</th>
              </tr>
            </thead>
            <tbody id="reportsTableBody" class="badger-report-table-body">
            </tbody>
            </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="exportReports" type="button" class="btn btn-info">Export</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <script src="js/bootstrap-multiselect.js" type="text/javascript"></script>
    <script src="js/select2.full.min.js" type="text/javascript"></script>
    <script src="js/jquery.timeago.js" type="text/javascript"></script>
    <script src="js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script src="js/bootstrap-switch.min.js" type="text/javascript"></script>
    <script src="js/js.cookie.js" type="text/javascript"></script>
    <script src="js/datatables.min.js" type="text/javascript"></script>
    <script src="js/gymbadger-percentage.js" type="text/javascript"></script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9OSRLuuH3o7YhJ6bRUVtD9TxhlSDqSDU&callback=initPage"></script>
    <script defer src="js/snazzy-info-window-hacked.js" type="text/javascript"></script>
        
    <script>
      var PARKS_ONLY_OPTION = 9999;
      var SELECT_ALL_OPTION = 9998;
    
      var map;
      var gymData;
      var selectedAreaIds = [];
      var parksOnly = false;
      var currentInfoWindow = null;
      var currentMarker = null;
      var currentProps = null;
      var reportTable = null;
      var raidBossData = null;

      function initPage() {
    	// Setup CSRF token
    	$.ajaxSetup({
    	  beforeSend : function(xhr, settings) {
    	    if (settings.type == 'POST' || settings.type == 'PUT'
    		  || settings.type == 'DELETE') {
    		  if (!(/^http:.*/.test(settings.url) || /^https:.*/
    		    .test(settings.url))) {
    		      // Only send the token to relative URLs i.e. locally.
    		      xhr.setRequestHeader("X-XSRF-TOKEN",
    		          Cookies.get('XSRF-TOKEN'));
    		    }
    		  }
    		}
        });
    	// Try to get logged in user details
      	$.ajax({
      		type: "GET",
      		contentType: "application/json; charset=utf-8",
      		url: "/api/users/currentUser", 
      		success: function (data) {
      	        $('#user').html(data.displayName);
      	        $('.badger-unauthenticated').hide();
      	        $('.badger-authenticated').show();
      		},
      		complete: function (res) {
      	        // Get defaults
        	    $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    url: "api/defaults/",
                    success: function (data) {
                	    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: data.zoom,
                        center: { lat: data.lat, lng: data.lng },
                        gestureHandling: 'greedy'
                        });
                    },
                    error: function (result) {
                	    errorPage("Failed to query default data", result);
                    },
                    complete: function (res) {
                	    initMarkers();
                    }
        	    });
      		}
        });   
      }
      
      function logout() {
    	  $.post("/logout", function() {
    	      $('#user').html('');
    	      $('.badger-unauthenticated').show();
    	      $('.badger-authenticated').hide();
    	      location.reload();
    	  });
          return true;
      }
      
      function initAreas() {
    	  // Get all the possible gym areas
    	  $.ajax({
              type: "GET",
              contentType: "application/json; charset=utf-8",
              url: "api/areas/",
              success: function (data) {
            	  selectedAreaIds.length=0;
            	  $('#filterButton').append($('<option>', {
        			  value: PARKS_ONLY_OPTION,
        			  text: 'Parks Only'
        		  }));
            	  $('#filterButton').append($('<optgroup>', {
            		  id: 'area-group',
        			  label: 'Select All Areas',
        			  value: SELECT_ALL_OPTION
        		  }));
            	  
            	  for (var i = 0; i < data.length; i++) {
            		  $('#area-group').append($('<option>', {
            			  value: data[i].id,
            			  text: data[i].name
            		  }));
            		  selectedAreaIds.push(data[i].id);
            	  }
              },
              error: function (result) {
              	errorPage("Failed to query area data", result);
              },
              complete: function (res) {
                $('#filterButton').multiselect({
                  buttonClass: 'btn btn-primary',
                  buttonContainer: '<div id="badger-dropdown-list" class="btn-group" />',
                  enableClickableOptGroups: true,
                  nonSelectedText: 'No areas',
                  allSelectedText: 'All areas',
                  maxHeight: 200,
                  optionClass: function(element) {
                	  var value = $(element).val();
                	  if (parseInt(value,10)===PARKS_ONLY_OPTION) {
                		  return 'badger-filter-option badger-dropdown-list-split';
                	  }
                      return 'badger-filter-option';
                  },
                  onChange: function(option, checked) {
                	  if (option.length === 1) {
                		  var id = parseInt($(option).val(),10);
                		  if (id===PARKS_ONLY_OPTION) {
                			  onChangeParkOption(checked);
                			  return;
                		  }
                	  }
                	  onChangeArea(option, checked);
                  }
                });
                selectAllAreas();
          	    $("#filterButton").multiselect('updateButtonText');
          	    resetPercentage();
        	    initSearch();  
              }
      	});
      }
      
      function selectAllAreas() {
    	  // Make sure all areas are selected and all gyms available for search
    	  selectedAreaIds.length=0;
    	  var areas = $('#filterButton option');
          $(areas).each(function(index, area){
        	  var id = parseInt(area.value,10);
        	  if (id !== PARKS_ONLY_OPTION) {
                  selectedAreaIds.push(parseInt(area.value,10));
        	  }
          });
          resetSearch();
          resetPercentage();
      
          // Ensure every single gym marker is shown
    	  for (var i = 0; i < gymData.length; i++) {
    		  gymData[i].marker.setVisible(true);
    	  }
    	  $("#filterButton").val(selectedAreaIds);
    	  $("#filterButton").multiselect("refresh");
      }

      function onChangeParkOption(checked) {
    	  if (checked) {
		      parksOnly=true;
		  } else {
			  parksOnly=false;
		  }
		  // For all the gyms in the selected areas filter them by park
		  for (var i = 0; i < gymData.length; i++) {
			  for (var j = 0; j < selectedAreaIds.length; j++) {
    			  if (gymData[i].area.id === selectedAreaIds[j]) {
    				  if (parksOnly && gymData[i].park===false) {
    					  gymData[i].marker.setVisible(false);
    				  } else {
    					  gymData[i].marker.setVisible(true);
    				  }
    			  }
			  }
		  }
		  resetSearch();
          resetPercentage();
      }

      function onChangeArea(option, checked) {
    	  // Update the list of selected area ids
    	  selectedAreaIds.length=0;
    	  var areas = $('#filterButton option:selected');
          $(areas).each(function(index, area){
              selectedAreaIds.push(parseInt(area.value,10));
          });
          resetSearch();
          resetPercentage();
          
    	  // Find all the gyms in the areas and either show or hide them
          for (var i = 0; i < gymData.length; i++) {
        	  for (var j = 0; j < option.length; j++) {
        		  var id = parseInt($(option[j]).val(),10);
        	      if (id===gymData[i].area.id) {
        	          if (checked) {
        	    	      if (parksOnly && gymData[i].park===false) {
        	    		      gymData[i].marker.setVisible(false);
        	    	      } else {
        	                  gymData[i].marker.setVisible(true);
        	    	      }
        		      } else {
        		          gymData[i].marker.setVisible(false);
        		      }
        	      }
              }
          }
      }

      function initMarkers() {
    	// Get all the gym positions and create markers for them
      	$.ajax({
            type: "GET",
              contentType: "application/json; charset=utf-8",
              url: "api/gyms/",
              success: function (data) {
            	  gymData = data;
                  for (var i = 0; i < gymData.length; i++) {
                	  // Add the marker
                      var marker = new google.maps.Marker({
                    	title: gymData[i].name,
                        position: { lat: gymData[i].lat, lng: gymData[i].lng },
                        icon: customIcon(gymData[i].status),
                        map: map
                      });
                	  gymData[i].marker = marker;
                      // Add a callback to create an info window for each marker if clicked
                      (function (marker, i) {
                        google.maps.event.addListener(marker, 'click', function () {
                            createInfoWindow(gymData[i], marker);
                        });
                      })(marker, i);
                  } 
              },
              complete: function (result) {
            	  initAreas();
              },
              error: function (result) {
              	errorPage("Failed to query gym data", result);
              }
      	});
      }

      function queryGymDataAndUpdateInfoWindow(thisGym) {
          $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: "api/comments/"+thisGym.id,
            success: function (data) {
                var htmlContent="";
                if (data.comments.length==0 && !data.loggedin) {
                    htmlContent = "<div class=\"alert alert-info badger-small-alert\" role=\"alert\">No comments posted yet.</div>";
                }
                for (var i = 0; i < data.comments.length; i++) {
                    var commentDate = new Date(data.comments[i].createdate);
                    htmlContent+="<div class=\"badger-comment\"><span class=\"badger-comment-user\">"+data.comments[i].displayname+"</span>" +
                        "<span class=\"badger-comment-text\">" + data.comments[i].text + "</span></div><div class=\"badger-sub-comment\">" + 
                        "<span class=\"badger-delete-link\">" + 
                        "<a class=\"badger-delete\" id=\"delete-link-" + data.comments[i].id + "\" data-commentid=\"" + data.comments[i].id + "\" href=\"#\">Delete</a></span>" + 
                        "<time class=\"timeago badger-comment-time\" datetime=\"" + commentDate.toISOString() + "\"></time>" +
                        "</div>";
                }
                if (data.loggedin) {
                    htmlContent+="<div><div class=\"badger-comment\"><textarea class=\"badger-comment-input\" name=\"message\" type=\"text\" id=\"input-message\" placeholder=\"Write a comment...\"></textarea></div>" +
                        "<div class=\"badger-comment-options\">" +
                            "<select id=\"badger-public-menu\" class=\"badger-public-menu\">" +
                                "<option class=\"dropdown-item badger-public-item\" selected>Public</option>" +
                                "<option class=\"dropdown-item badger-public-item\">Private</option>" +
                            "</select>" + 
                            "<button id=\"badger-post-button\" type=\"button\" class=\"btn btn-primary badger-comment-post\">Post</button>" +
                        "</div></div>";
                }
                $('#comments').html(htmlContent);
                $('time.badger-comment-time').timeago();
                $('.badger-delete').on('click', function() {
                    var idtodelete = $(this).attr('data-commentid');
                    $.ajax({
                        type: "DELETE",
                        contentType: "application/json; charset=utf-8",
                        url: "api/comments/"+idtodelete,
                        success: function (data) {
                            // Update the UI by removing old raid time and adding new one
                            $('#comments').html('Loading...');
                            queryGymDataAndUpdateInfoWindow(thisGym);
                        },
                        error: function (result) {
                            errorPage("Failed to delete comment", result);
                        }
    	            });     
                });
                
                $('#badger-public-menu').select2({
                    minimumResultsForSearch: Infinity,
                    containerCssClass: 'badger-public-menu',
                    dropdownCssClass: 'badger-public-item'
                });
                $('#badger-post-button').on('click', function () {
                    var comment = $('#input-message').val();
                    var selectedText = $('#badger-public-menu').val();
                    var ispublic = false;
                    if (selectedText == 'Public') {
                        ispublic = true;
                    }
                    if (comment.length == 0) {
                        return;
                    }
                    var postData = {
                        gymid: thisGym.id,
                        text: comment,
                        ispublic: ispublic
                    };
                    $.ajax({
                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        url: "api/comments/",
                        data: JSON.stringify(postData),
                        success: function (data) {
                            // Update the UI by removing old raid time and adding new one
                            $('#comments').html('Loading...');
                            queryGymDataAndUpdateInfoWindow(thisGym);
                        },
                        error: function (result) {
                            errorPage("Failed to post new comment", result);
                        }
    	            }); 
                });
            },
            error: function (result) {
                $('#comments').html("<div class=\"alert alert-danger badger-small-alert\" role=\"alert\">Failed to query gym comments.</div>");
            }
          });
      }
 
      function createInfoWindow(data, marker) {
          var content = "<div class=\"badger-info-title\">" + 
              "<div class=\"dropdown badger-info-title-container\">" +
                  "<button class=\"btn btn-default badger-small-button\" type=\"button\" id=\"dropdownMenuButton\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">" +
                      "<span class=\"badger-badge-container\"><span id=\"infoBadge\" class=\"badger-badge " + getBadgeClass(data.status) + "\"></span></span>" +
                  "</button>" +
                  "<div class=\"dropdown-menu\" aria-labelledby=\"dropdownMenuButton\">" +
                      "<a id=\"select-gold\" class=\""+ getDropdownBadgeClass(data.status, "GOLD") + "\" href=\"#\">Gold</a>" +
                      "<a id=\"select-silver\" class=\""+ getDropdownBadgeClass(data.status, "SILVER") + "\" href=\"#\">Silver</a>" +
                      "<a id=\"select-bronze\" class=\""+ getDropdownBadgeClass(data.status, "BRONZE") + "\" href=\"#\">Bronze</a>" +
                      "<a id=\"select-basic\" class=\""+ getDropdownBadgeClass(data.status, "BASIC") + "\" href=\"#\">Basic</a>" +
                      "<a id=\"select-none\" class=\""+ getDropdownBadgeClass(data.status, "NONE") + "\" href=\"#\">None</a>" +
                  "</div>" +
                  "<span class=\"badger-info-title-placeholder\"><span class=\"badger-info-title-text\">" + data.name + "</span></span>" +
              "</div>" +
              "</div>" +
              "<div id=\"badger-area-container\">" + 
                  "<span class=\"badge badge-primary badger-small-pill\">" + data.area.name + "</span>" +
                      getParkStatus(data.park) + 
               "</div>" + 
               getLastRaid(data) +
               "<div class=\"badger-comments-group\"><div class=\"badger-comments-label\">Comments</div>" + 
                   "<div id=\"comments\" class=\"badger-comments-container\">Loading...</div>" +
          "</div>";
               
          currentMarker = marker;
          currentProps = data;
          closeAnyInfoWindows();
                    		
          var popup = document.createElement('div');
          popup.setAttribute('class', 'badger-info');
          popup.innerHTML = content;
                    	
          currentInfoWindow = new SnazzyInfoWindow({
               map: map,
               marker: currentMarker,
               wrapperClass: 'badger-info-wrapper',
               closeButtonMarkup: "<button type=\"button\" class=\"btn btn-outline-secondary badger-info-close\">&#215;</button>",
               closeWhenOthersOpen: false,
               closeOnMapClick: true,
               content: popup,
               padding: '6px',
               maxWidth: 350,
               mapTop: 66,
               edgeOffset: {
                   top: 65,
                   right: 25,
                   bottom: 25,
                   left: 25
               },
               callbacks: {
                   afterOpen: function() {
                       $('.badger-dropdownitem').click(function() {
                           selectBadge(currentMarker, currentProps, getStatusFromId(this.id));
                       });
                 	   $('.badger-info-close').click(function() {
                           closeAnyInfoWindows();
                       });
                       registerRaidEvents();
                       queryGymDataAndUpdateInfoWindow(data);
                   },
                   afterClose: function() {
                       // Forget any advanced options since gym info window is closing
                       resetAdvancedOptions();
                   }
              }
          });
          currentInfoWindow.open();
      }

      function registerRaidEvents() {
        // remove old popovers from the DOM
        $('.popover').remove();
        
        // Enable date/time plugin for the raid dates
        $('time.badger-raid-time').timeago();
      	
      	// Setup the three raid button menu options
      	$('#now').click(function() {
      		selectRaid(currentProps, new Date());
        });
             
        $('#raidPopover1').popover({
      	    trigger: "manual",
            placement: 'auto',
            viewport: '#badger-container', 
            html: true,
            title: 'Choose a date <a href="#" class="close" data-dismiss="alert">&times;</a>',
            content: "<div class=\"badger-date-popover\"></div>"
        });
        $('#raidPopover1').on('shown.bs.popover', function(){
            $('.badger-date-popover').datetimepicker({
      		    format: 'dd-mm-yyyy',
      		    autoclose: true,
      		    todayHighlight: true,
      		    minView: 2
      	    }).on('changeDate', function(e) {
      		    selectRaid(currentProps, e.date);
      	    });
        });
        $('#choose').click(function() {
      		$("#raidPopover1").popover("show");
        });
        
        $('#options').click(function() {
            initAdvancedOptions();
      		$("#advancedOptions").modal('show');
        });

        $(document).on("click", ".popover .close" , function(){
        	$(this).parents(".popover").popover('hide');
        });
      }

      function getLastRaid(data) {
    	  return getLastRaidDetails(data, "", true);
      }
      
      function getLastRaidForReport(data) {
    	  return getLastRaidDetails(data, "-small", false);
      }
      
      function getLastRaidDetails(data, containerClass, includeButton) {
    	  var htmlContent = "";
    	  if (data.lastRaid!=null) {
    		  var lastRaidDate = new Date(data.lastRaid);
        	  if (!includeButton) {
        		  htmlContent = "<td data-order=\"" + data.lastRaid + "\">";
        	  }
    		  htmlContent += "<div id=\"badger-info-raid" + data.id + "\" class=\"alert alert-success badger-raid-container badger-last-raid" + containerClass +" collapsed\"" + 
    		        "data-toggle=\"collapse\" href=\"#collapseDate" + data.id + "\" aria-expanded=\"false\" aria-controls=\"collapseDate" + data.id + "\">" +
    		          "<div class=\"badger-info-raid\">Last raided <time class=\"timeago badger-raid-time\" datetime=\"" + lastRaidDate.toISOString() + "\"></time>" +
    		          "<div id=\"collapseDate" + data.id + "\" class=\"collapse hide\" role=\"tabpanel\" aria-labelledby=\"badger-info-raid" + data.id + "\" data-parent=\"#badger-info\">" +
        		        "<div class=\"badger-time-badge-container\"><span class=\"badge badge-success badger-time-badge\">" +
        		          lastRaidDate.toLocaleString() +
        		          "</span></div>" + getRaidPokemonHtml(data) +
        		      "</div>" +
    		          "</div>" +
    	              getRaidButtonHtml(includeButton) + "</div>";
    	      return htmlContent;
    	  } else {
    		  if (!includeButton) {
        		  htmlContent = "<td data-order=\"0\">";
        	  }
    	      htmlContent += "<div id=\"badger-info-raid\" class=\"alert alert-warning badger-raid-container badger-no-raid" + containerClass +"\"><div>No raid recorded yet</div>" +
    	          getRaidButtonHtml(includeButton) + "</div>";
    	  }
    	  if (!includeButton) {
    		  htmlContent += "</td>";
    	  }
          return htmlContent;
      }

      function getRaidButtonHtml(includeButton) {
    	  if (!includeButton) {
    		  return "";
    	  }
    	  return "<div class=\"dropdown badger-info-raid-dropdown\">" +
	        "<button class=\"btn btn-info badger-info-raid-button\" type=\"button\" id=\"raidMenuButton\" data-toggle=\"dropdown\"" +
	        " aria-haspopup=\"true\" aria-expanded=\"false\">" + 
	            "<span class=\"badger-raid-button-container\">" +
	                "<span>Raid</span>" +
	            "</span>" +
	        "</button>" +
	            "<div class=\"dropdown-menu\" aria-labelledby=\"raidMenuButton\">" +
	              "<a id=\"now\" class=\"dropdown-item badger-info-raid-item\" href=\"#\">Now</a>" +
	          "<a id=\"choose\" class=\"dropdown-item badger-info-raid-item\" data-provide=\"datepicker\" href=\"#\">Choose a Date</a>" +
	          "<a id=\"options\" class=\"dropdown-item badger-info-raid-item\" href=\"#\">Advanced</a>" +
	        "</div>" +
	        "<span id=\"raidPopover1\"></span><span id=\"raidPopover2\"></span>" +
	      "</div>";
      }

      function selectRaid(props, lastRaid) {
    	  props.lastRaid = lastRaid;
          $.ajax({
            type: "PUT",
            contentType: "application/json; charset=utf-8",
            url: "api/gyms/"+props.id,
            data: JSON.stringify(props, ["id", "name", "lat", "lng", "park", "status", "lastRaid"]),
            success: function (data) {
              currentProps = data;
              // Update the UI by removing old raid time and adding new one
              $('.badger-raid-container').remove();
              $('#badger-area-container').after(getLastRaid(data));
              registerRaidEvents();
            },
            error: function (result) {
              errorPage("Failed to update last raid", result);
            }
    	  }); 	  
      }

      function resetPercentage() {
    	  // Calculate the percentage
    	  var data = getPercentGold();
    	  // Clear previous percentage
    	  $('#badger-gold-percent').html('');
    	  // Draw the new percentage
    	  var el = document.getElementById('badger-gold-percent');
    	  drawPercentage(el, 42, 5, data.amount, data.total, '#efefef', '#f0f000', true, false);
      }

      function getSearchData() {
    	  var searchData = $.map(gymData, function (obj) {
    		  // Only include the gyms in the list of filtered areas
    		  for (var i = 0; i < selectedAreaIds.length; i++) {
    		      if (selectedAreaIds[i]===obj.area.id) {
    		    	  if (!parksOnly || obj.park===true) {
    		              obj.text = obj.name;
    		              return obj;
    		    	  }
    		      }
    		  }
    		  return null;
          });
    	  return searchData;
      }

      function initSearch() {
    	  $("#search").select2({
    		  placeholder: "Search",
    		  width: '100%',
    		  data: getSearchData()
    	  });
    	  $("#search").on("select2:select", function(e) {
    	      map.setCenter({ lat: e.params.data.lat, lng: e.params.data.lng});
    	      google.maps.event.trigger(e.params.data.marker, 'click');
          });
    	  initRaidBosses();
      }

      function resetSearch() {
    	  closeAnyInfoWindows();
    	  $("#search option").remove(); 
    	  $("#search").html("<option></option>");
    	  $("#search").select2({
    		  placeholder: "Search",
    		  width: '100%',
    		  data: getSearchData()
    	  });
    	  $('#search').change();
      }

      function selectBadge(marker, props, status) {
    	  var oldStatus = props.status;
    	  props.status=status;
    	  $.ajax({
            type: "PUT",
            contentType: "application/json; charset=utf-8",
            url: "api/gyms/"+props.id,
            data: JSON.stringify(props, ["id", "name", "lat", "lng", "park", "status", "lastRaid", "pokemonId", "caught"]),
            success: function (data) {
              marker.setIcon(customIcon(props.status));
              $("#infoBadge").removeClass(getBadgeClass(oldStatus));
              $("#infoBadge").addClass(getBadgeClass(props.status));
              resetPercentage();
            },
            error: function (result) {
              errorPage("Failed to update gym data", result);
            }
    	  });
      }

      function closeAnyInfoWindows() {
          if (currentInfoWindow != null) {
		      currentInfoWindow.destroy();
		      currentInfoWindow = null;
		  }
      }
      
      function getRaidPokemonHtml(data) {
    	  if (data.pokemonId == null) {
    		  return "";
    	  }
    	  // Set the pill colour to be green for cuaght, red for fled
    	  var pillClass = "badge-info";
    	  if (data.caught != null) {
    		  if (data.caught) {
    			  pillClass = "badge-success";
    		  } else {
    			  pillClass = "badge-danger";
    		  }
    	  }
    	  var pokemonName = null;
    	  for (var i = 0; i < raidBossData.length; i++) {
    	      if (raidBossData[i].id == data.pokemonId) {
    	    	  pokemonName = raidBossData[i].text;
    	    	  break;
    	      }
    	  }
          if (pokemonName == null) {
        	  return "";
          }
    	  return "<div class=\"badger-pokemon-container\"><span class=\"badge " + pillClass + " badger-pokemon-badge\">" +
              pokemonName +
              "</span></div>";
      }

      function getBadgeColor (status) {
    	  if (status==="BASIC") {
    		  return '#b3ffb3';
    	  }
    	  if (status==="BRONZE") {
    		  return '#ffb366';
    	  }
    	  if (status==="SILVER") {
    		  return '#e0e0d1';
    	  }
    	  if (status==="GOLD") {
    		  return '#ffff00';
    	  }
    	  return '#b3daff';
      }

      function customIcon (status) {
    	  var ret = {
    		path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0',
    		fillColor: getBadgeColor(status),
      	    fillOpacity: 1,
      	    strokeColor: '#000',
      	    strokeWeight: 2,
      	    scale: 1
    	  };
    	  return ret;
      }
      
      function getBadgeEffort (status) {
    	  if (status==="BASIC") {
    		  return 1;
    	  }
    	  else if (status==="BRONZE") {
    		  return 3;
    	  }
    	  else if (status==="SILVER") {
    		  return 7;
    	  }
    	  else if (status==="GOLD") {
    		  return 19;
    	  }
    	  return 0;
      }
      
      function getBadgeOrder (status) {
    	  if (status==="BASIC") {
    		  return 1;
    	  }
    	  else if (status==="BRONZE") {
    		  return 2;
    	  }
    	  else if (status==="SILVER") {
    		  return 3;
    	  }
    	  else if (status==="GOLD") {
    		  return 4;
    	  }
    	  return 0;
      }
      
      function getBadgeClass (status) {
    	  if (status==="BASIC") {
    		  return 'badger-badge-basic';
    	  }
    	  else if (status==="BRONZE") {
    		  return 'badger-badge-bronze';
    	  }
    	  else if (status==="SILVER") {
    		  return 'badger-badge-silver';
    	  }
    	  else if (status==="GOLD") {
    		  return 'badger-badge-gold';
    	  }
    	  return 'badger-badge-none';
      }
      
      function getStatusFromId (id) {
    	  if (id==="select-basic")
    		  return "BASIC";
    	  if (id==="select-bronze")
    		  return "BRONZE";
    	  if (id==="select-silver")
    		  return "SILVER";
    	  if (id==="select-gold")
    		  return "GOLD";
    	  return "NONE";
      }
      
      function getDropdownBadgeClass (currentStatus, targetStatus) {
          var classes = "dropdown-item badger-dropdownitem";
    	  if (currentStatus===targetStatus) {
    		  classes+=" badger-dropdownitem-checked";
    	  }
    	  return classes;
      }
      
      function getParkStatus (park) {
    	  if (park) {
    		  return "<span class=\"badge badge-success badger-small-pill-lm\">park</span>";
    	  }
    	  return "";
      }

      function getPercentGold() {
		  return getPercent(false, 'GOLD');    	  
      }
      
      function getPercentVisited() {
          return getPercent(true, 'NONE');
      }

      function getPercent(includeAll, status) {
    	  var results = { total: 0, amount: 0 };
    	  for (var i = 0; i < gymData.length; i++) {
    		  for (var j = 0; j < selectedAreaIds.length; j++) {
    			  if (gymData[i].area.id === selectedAreaIds[j]) {
    				  if (!parksOnly || gymData[i].park===true) {
    				      results.total++;
    				      if ((includeAll && gymData[i].status!==status) || (!includeAll && gymData[i].status===status)) {
    				          results.amount++;
    			          }
    				  }
    			  }
    		  }
    	  }
    	  return results;
      }

      function getPercentTotal() {
    	  var results = { total: 0, amount: 0 };
    	  for (var i = 0; i < gymData.length; i++) {
    		  for (var j = 0; j < selectedAreaIds.length; j++) {
    			  if (gymData[i].area.id === selectedAreaIds[j]) {
    				  if (!parksOnly || gymData[i].park===true) {
    				      results.total = results.total + getBadgeEffort('GOLD');
    				      results.amount = results.amount + getBadgeEffort(gymData[i].status);
    				  }
    			  }
    		  }
    	  }
    	  return results;
      }
      
      function errorPage(title, results) {
    	  $("#errorPageTitle").text(title);
    	  if (results.responseJSON !== undefined) {
    	      $("#errorPageBody").text(results.responseJSON.message);
    	  }
    	  $('#errorPage').modal('show');
      }
      
      function showReports() {
    	  closeAnyInfoWindows();
    	  for (var i = 0; i < gymData.length; i++) {
    	      for (var j = 0; j < selectedAreaIds.length; j++) {
	    	      if (gymData[i].area.id === selectedAreaIds[j]) {
	    		      if (!parksOnly || gymData[i].park===true) {
	    		          $("#reportsTableBody").append("<tr>" +
	    	                  "<td>" + gymData[i].name + "</td>" +
	    	                  "<td data-order=\"" + getBadgeOrder(gymData[i].status) + "\">" + 
	    	                      "<div id=\"infoBadge\" class=\"badger-badge " + getBadgeClass(gymData[i].status) + "\"></div>" +
	    	                  "</td>" +
	    	                  "<td><div id=\"badger-area-container\">" + 
	        		              "<div class=\"badge badge-primary badger-small-pill\">" + gymData[i].area.name + "</div></div>" +
	        		          "</td><td><div id=\"badger-area-container\">" +
	        		              getParkStatus(gymData[i].park) + "</div></td>" + 
	        		              getLastRaidForReport(gymData[i]) +
	    	              "</tr>");
	    	          }
	    	      }
	    	  }
	      }
    	  $("time.badger-raid-time").timeago();
    	  reportTable = $("#reportsTable").DataTable({
    	    "autoWidth": true,
    		"scrollY": 300,
    	    "scrollX": true,
    	    "columns": [ {"searchable": true}, {"searchable": false}, {"searchable": false}, {"searchable": false}, {"searchable": false} ]
    	  });
    	  // Show the percentage reports
    	  var data = getPercentVisited();
    	  $('#badger-rep-visited-percent').html('');
    	  var el = document.getElementById('badger-rep-visited-percent');
    	  drawPercentage(el, 62, 8, data.amount, data.total, '#a9a9a9', '#9acd32', true, true);

    	  var data = getPercentGold();
    	  $('#badger-rep-gold-percent').html('');
    	  // Draw the new percentage
    	  var el = document.getElementById('badger-rep-gold-percent');
    	  drawPercentage(el, 62, 8, data.amount, data.total, '#a9a9a9', '#f0f000', true, true);

    	  var data = getPercentTotal();
    	  $('#badger-rep-total-percent').html('');
    	  var el = document.getElementById('badger-rep-total-percent');
    	  drawPercentage(el, 62, 8, data.amount, data.total, '#a9a9a9', '#87cefa', false, true);

          $('#reportsPage').on('hidden.bs.modal', function() {
    	      $("#reportsTable").DataTable().destroy();
    	      $("#reportsTableBody").html("");
          });

    	  // Show the window
    	  $('#reportsPage').on('shown.bs.modal', function () {
    		  reportTable.columns.adjust().draw();
    	  });
    	  $("#reportsPage").modal('show');
      }

      function initRaidBosses() {
    	  $.ajax({
              type: "GET",
              contentType: "application/json; charset=utf-8",
              url: "api/bosses/",
              success: function (data) {
          	    raidBossData = data;
              },
              error: function (result) {
          	    errorPage("Failed to query raid boss data", result);
              }
  	      });
	  }
      
      function initAdvancedOptions() {
    	// Fill in fields with currentProps
      	$('#badger-opt-date').datetimepicker({
          	format: 'dd-mm-yyyy',
        		autoclose: true,
        		todayHighlight: true,
        		minView: 2
          }).on('changeDate', function(ev){
          	$('#badger-opt-time').datetimepicker('update', ev.date);
          });
          $('#badger-opt-time').datetimepicker({
          	format: 'dd-mm-yyyy hh:ii',
        		autoclose: true,
        		startView: 1
          });
          if (currentProps.lastRaid!=null) {
    		    var lastRaidDate = new Date(currentProps.lastRaid);
    		    $('#badger-opt-date').datetimepicker('update', lastRaidDate);
    		    $('#badger-opt-time').datetimepicker('update', lastRaidDate);
          }

          $('#poke-search').select2({
    		  placeholder: "Pokemon",
    		  width: '100%',
    		  data: raidBossData
    	    });
          var caught = false;
          if (currentProps.caught != null) {
        	  caught = currentProps.caught;
          }
          $('#caught-switch').bootstrapSwitch({
          	state: caught,
          	onColor: 'success',
          	offColor: 'danger',
          	labelText: 'Caught',
          	onText: 'Yes',
          	offText: 'No'
          });
          $('#badger-opt-save').on('click', function (e) {
          	var lastRaid = "";
          	var date = $("#badger-opt-date").data("datetimepicker").getDate();
          	var time = $('#badger-opt-time').data("datetimepicker").getDate();
          	if (time!=null) {
          		lastRaid = time;
          	} else {
          		lastRaid = date;
          	}
          	var pokemonId = parseInt($('#poke-search').val(), 10);
          	var isCaught = $('#caught-switch').bootstrapSwitch('state');
          	saveAdvanced(lastRaid, pokemonId, isCaught);
          });
          if (currentProps.pokemonId!=null) {
              $('#poke-search').val(currentProps.pokemonId.toString());
              $('#poke-search').trigger('change');
          }
      }

      function saveAdvanced(lastRaid, pokemonId, caught) {
    	  var props = currentProps;
    	  props.lastRaid=lastRaid;
    	  props.pokemonId=pokemonId;
    	  props.caught=caught;
          $.ajax({
            type: "PUT",
            contentType: "application/json; charset=utf-8",
            url: "api/gyms/"+props.id,
            data: JSON.stringify(props, ["id", "name", "lat", "lng", "park", "status", "lastRaid", "pokemonId", "caught"]),
            success: function (data) {
              currentProps = data;
              // Update the UI by removing old raid time and adding new one
              $('.badger-raid-container').remove();
              $('#badger-area-container').after(getLastRaid(data));
              registerRaidEvents();
            },
            error: function (result) {
              errorPage("Failed to update advanced options", result);
            },
            complete: function (res) {
              $('#advancedOptions').modal('hide');
            }
    	  }); 	  
      }
 
      function resetAdvancedOptions() {
          $('#poke-search').val("");
          $('#poke-search').trigger('change');
          $('#badger-opt-date').datetimepicker('remove');
          $('#badger-opt-time').datetimepicker('remove');
          $('.badger-opt-date-text').val("");
          $('#caught-switch').bootstrapSwitch('destroy');
      }

    </script>
  </body>
</html>
