<!DOCTYPE html>
<html>
  <head>
    <title>GymBadger</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-multiselect.css"/>
    <link rel="stylesheet" href="css/select2.min.css"/>
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css"/>
    <link rel="stylesheet" href="css/datatables.min.css"/>
    <link rel="stylesheet" href="css/badgerstyle.css"/>
    <link rel="stylesheet" href="css/snazzy-info-window.min.css">
      
  </head>
  <body>

    <nav class="navbar navbar-expand-md navbar-static-top navbar-dark bg-primary badger-navbar">
      <a class="navbar-brand" href="/tos">
        <img src="/images/badger.png" width="48" height="48" class="d-inline-block" alt="">
        <span class="badger-navbar-title">GymBadger</span>
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse badger-list-row" id="navbarNavDropdown">
        <ul class="navbar-nav ml-auto">
          <li class="badger-authenticated" style="display: none;">
              <span id="badger-gold-percent" class="badger-navbar-label"></span>
          </li>
          <li class="nav-item nav-link">
            <select id="filterButton" class="badger-filtericon-hidden" multiple="multiple">
            </select>
          </li>
          <li class="nav-item nav-link">
            <select id="search" name="search" class="form-control"><option></option></select>
          </li>
          <li class="nav-item nav-link">
            <div class="badger-unauthenticated">
              <a href="/login" class="btn btn-primary badger-login-button"><i class="fa fa-facebook badger-login-icon"></i>Sign In</a>
            </div>
            <div class="badger-authenticated btn-group" style="display: none;">
                <button class="dropdown-toggle btn btn-primary badger-user-button" type="button" id="userMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="badger-user-container"><span id="user"></span></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right badger-user-menu" aria-labelledby="userMenuButton">
                    <li><a id="reports" class="dropdown-item badger-user-item" onclick="return showReports();">Reports</a></li>
                    <li><a id="logout" class="dropdown-item badger-user-item" onclick="return logout();">Logout</a></li>
                </ul>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    
    <div class="container-fluid badger-container">
      <div id="map"></div>
    </div>

    <div class="modal fade" id="errorPage" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="errorPageTitle" class="modal-title"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="errorPageBody"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>   
    </div>
    </div>

    <div class="modal fade" id="reportsPage" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reports</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body badger-report-page-body">
          <table id="reportsTable" class="table table-striped table-bordered badger-report-table" style="width: 100%;">
          <thead>
            <tr>
              <th>Gym</th>
              <th>Badge</th>
              <th>Area</th>
              <th>Park</th>
              <th>Raided</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody" class="badger-report-table-body">
          </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <script src="js/bootstrap-multiselect.js" type="text/javascript"></script>
    <script src="js/select2.full.min.js" type="text/javascript"></script>
    <script src="js/jquery.timeago.js" type="text/javascript"></script>
    <script src="js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script src="js/js.cookie.js" type="text/javascript"></script>
    <script src="js/datatables.min.js" type="text/javascript"></script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9OSRLuuH3o7YhJ6bRUVtD9TxhlSDqSDU&callback=initPage"></script>
    <script defer src="js/snazzy-info-window.min.js" type="text/javascript"></script>
        
    <script>
      var PARKS_ONLY_OPTION = 9999;
      var SELECT_ALL_OPTION = 9998;
    
      var map;
      var gymData;
      var selectedAreaIds = [];
      var parksOnly = false;
      var currentInfoWindow = null;
      var currentMarker = null;
      var currentProps = null;
      var reportTable = null;

      function initPage() {
    	// Setup CSRF token
    	$.ajaxSetup({
    	  beforeSend : function(xhr, settings) {
    	    if (settings.type == 'POST' || settings.type == 'PUT'
    		  || settings.type == 'DELETE') {
    		  if (!(/^http:.*/.test(settings.url) || /^https:.*/
    		    .test(settings.url))) {
    		      // Only send the token to relative URLs i.e. locally.
    		      xhr.setRequestHeader("X-XSRF-TOKEN",
    		          Cookies.get('XSRF-TOKEN'));
    		    }
    		  }
    		}
        });
    	// Try to get logged in user details
      	$.ajax({
      		type: "GET",
      		contentType: "application/json; charset=utf-8",
      		url: "/api/users/currentUser", 
      		success: function (data) {
      	        $("#user").html(data.displayName);
      	        $(".badger-unauthenticated").hide();
      	        $(".badger-authenticated").show();
      		},
      		complete: function (res) {
      	        // Get defaults
        	    $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    url: "api/defaults/",
                    success: function (data) {
                	    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: data.zoom,
                        center: { lat: data.lat, lng: data.lng },
                        gestureHandling: 'greedy'
                        });
                    },
                    error: function (result) {
                	    errorPage("Failed to query default data", result);
                    },
                    complete: function (res) {
                	    initMarkers();
                    }
        	    });
      		}
        });   
      }
      
      function logout() {
    	  $.post("/logout", function() {
    	      $("#user").html('');
    	      $(".badger-unauthenticated").show();
    	      $(".badger-authenticated").hide();
    	      location.reload();
    	  });
          return true;
      }
      
      function initAreas() {
    	  // Get all the possible gym areas
    	  $.ajax({
              type: "GET",
              contentType: "application/json; charset=utf-8",
              url: "api/areas/",
              success: function (data) {
            	  selectedAreaIds.length=0;
            	  $('#filterButton').append($('<option>', {
        			  value: PARKS_ONLY_OPTION,
        			  text: 'Parks Only'
        		  }));
            	  $('#filterButton').append($('<optgroup>', {
            		  id: 'area-group',
        			  label: 'Select All Areas',
        			  value: SELECT_ALL_OPTION
        		  }));
            	  
            	  for (var i = 0; i < data.length; i++) {
            		  $('#area-group').append($('<option>', {
            			  value: data[i].id,
            			  text: data[i].name
            		  }));
            		  selectedAreaIds.push(data[i].id);
            	  }
              },
              error: function (result) {
              	errorPage("Failed to query area data", result);
              },
              complete: function (res) {
                $("#filterButton").multiselect({
                  buttonClass: 'btn btn-primary',
                  buttonContainer: '<div id="badger-dropdown-list" class="btn-group" />',
                  enableClickableOptGroups: true,
                  nonSelectedText: 'No areas',
                  allSelectedText: 'All areas',
                  maxHeight: 200,
                  optionClass: function(element) {
                	  var value = $(element).val();
                	  if (parseInt(value,10)===PARKS_ONLY_OPTION) {
                		  return 'badger-filter-option badger-dropdown-list-split';
                	  }
                      return 'badger-filter-option';
                  },
                  onChange: function(option, checked) {
                	  if (option.length === 1) {
                		  var id = parseInt($(option).val(),10);
                		  if (id===PARKS_ONLY_OPTION) {
                			  onChangeParkOption(checked);
                			  return;
                		  }
                	  }
                	  onChangeArea(option, checked);
                  }
                });
                selectAllAreas();
          	    $("#filterButton").multiselect('updateButtonText');
          	    resetPercentage();
        	    initSearch();  
              }
      	});
      }
      
      function selectAllAreas() {
    	  // Make sure all areas are selected and all gyms available for search
    	  selectedAreaIds.length=0;
    	  var areas = $('#filterButton option');
          $(areas).each(function(index, area){
        	  var id = parseInt(area.value,10);
        	  if (id !== PARKS_ONLY_OPTION) {
                  selectedAreaIds.push(parseInt(area.value,10));
        	  }
          });
          resetSearch();
          resetPercentage();
      
          // Ensure every single gym marker is shown
    	  for (var i = 0; i < gymData.length; i++) {
    		  gymData[i].marker.setVisible(true);
    	  }
    	  $("#filterButton").val(selectedAreaIds);
    	  $("#filterButton").multiselect("refresh");
      }

      function onChangeParkOption(checked) {
    	  if (checked) {
		      parksOnly=true;
		  } else {
			  parksOnly=false;
		  }
		  // For all the gyms in the selected areas filter them by park
		  for (var i = 0; i < gymData.length; i++) {
			  for (var j = 0; j < selectedAreaIds.length; j++) {
    			  if (gymData[i].area.id === selectedAreaIds[j]) {
    				  if (parksOnly && gymData[i].park===false) {
    					  gymData[i].marker.setVisible(false);
    				  } else {
    					  gymData[i].marker.setVisible(true);
    				  }
    			  }
			  }
		  }
		  resetSearch();
          resetPercentage();
      }

      function onChangeArea(option, checked) {
    	  // Update the list of selected area ids
    	  selectedAreaIds.length=0;
    	  var areas = $('#filterButton option:selected');
          $(areas).each(function(index, area){
              selectedAreaIds.push(parseInt(area.value,10));
          });
          resetSearch();
          resetPercentage();
          
    	  // Find all the gyms in the areas and either show or hide them
          for (var i = 0; i < gymData.length; i++) {
        	  for (var j = 0; j < option.length; j++) {
        		  var id = parseInt($(option[j]).val(),10);
        	      if (id===gymData[i].area.id) {
        	          if (checked) {
        	    	      if (parksOnly && gymData[i].park===false) {
        	    		      gymData[i].marker.setVisible(false);
        	    	      } else {
        	                  gymData[i].marker.setVisible(true);
        	    	      }
        		      } else {
        		          gymData[i].marker.setVisible(false);
        		      }
        	      }
              }
          }
      }

      function initMarkers() {
    	// Get all the gym positions and create markers for them
      	$.ajax({
            type: "GET",
              contentType: "application/json; charset=utf-8",
              url: "api/gyms/",
              success: function (data) {
            	  gymData = data;
                  for (var i = 0; i < gymData.length; i++) {
                	  // Add the marker
                      var marker = new google.maps.Marker({
                    	title: gymData[i].name,
                        position: { lat: gymData[i].lat, lng: gymData[i].lng },
                        icon: customIcon(gymData[i].status),
                        map: map
                      });
                	  gymData[i].marker = marker;
                      // Add a callback to create an info window for each marker if clicked
                      (function (marker, i) {
                        google.maps.event.addListener(marker, 'click', function () {
                        	var content = "<div class=\"badger-info\"><div class=\"badger-info-title\">" + 
                        	  "<div class=\"dropdown badger-info-title-container\">" +
                        	    "<button class=\"btn btn-default badger-small-button\" type=\"button\" id=\"dropdownMenuButton\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">" +
                        	    "<span class=\"badger-badge-container\"><span id=\"infoBadge\" class=\"badger-badge " + getBadgeClass(data[i].status) + "\"></span></span>" +
                         	    "</button>" +
                        	    "<div class=\"dropdown-menu\" aria-labelledby=\"dropdownMenuButton\">" +
                        	      "<a id=\"select-gold\" class=\""+ getDropdownBadgeClass(gymData[i].status, "GOLD") + "\" href=\"#\">Gold</a>" +
                        	      "<a id=\"select-silver\" class=\""+ getDropdownBadgeClass(gymData[i].status, "SILVER") + "\" href=\"#\">Silver</a>" +
                        	      "<a id=\"select-bronze\" class=\""+ getDropdownBadgeClass(gymData[i].status, "BRONZE") + "\" href=\"#\">Bronze</a>" +
                        	      "<a id=\"select-basic\" class=\""+ getDropdownBadgeClass(gymData[i].status, "BASIC") + "\" href=\"#\">Basic</a>" +
                        	      "<a id=\"select-none\" class=\""+ getDropdownBadgeClass(gymData[i].status, "NONE") + "\" href=\"#\">None</a>" +
                        	    "</div>" +
                        	    "<span class=\"badger-info-title-placeholder\"><span class=\"badger-info-title-text\">" + gymData[i].name + "</span></span>" +
                        	  "</div>" +
                        	"</div>" +
                    		"<div id=\"badger-area-container\">" + 
                    		  "<span class=\"badge badge-primary badger-small-pill\">" + gymData[i].area.name + "</span>" +
                    		  getParkStatus(gymData[i].park) + "</div>" + 
                    		  getLastRaid(gymData[i].lastRaid, true) +
                    		"<div><div>Comments</div><div><textarea class=\"badger-comments\" id=\"comments\"></textarea>" +
                            "</div></div>" +
                    		"</div>";
                    		currentMarker = marker;
                    		currentProps = gymData[i];
                    		closeAnyInfoWindows();
                    		currentInfoWindow = new SnazzyInfoWindow({
                    			map: map,
                    			marker: currentMarker,
                    			closeWhenOthersOpen: false,
                    			closeOnMapClick: false,
                    			content: content,
                    			padding: '6px',
                    			maxWidth: 350,
                    			callbacks: {
                    			  afterOpen: function() {
                    				$('.badger-dropdownitem').click(function() {
                                        selectBadge(currentMarker, currentProps, getStatusFromId(this.id));
                                    });
                                	registerRaidEvents();
                    			  }
                    			}
                    	    });
                    		currentInfoWindow.open();
                        });
                      })(marker, i);
                  } 
              },
              complete: function (result) {
            	  initAreas();
              },
              error: function (result) {
              	errorPage("Failed to query gym data", result);
              }
      	});
      }
      
      function registerRaidEvents() {
        $("time.timeago").timeago();
      	$('#now').click(function() {
      		selectRaid(currentProps, new Date());
          });
      	$('#choose').datetimepicker({
      		format: 'dd-mm-yyyy hh:ii',
      		autoclose: true,
      		todayHighlight: true
      	}).on('changeDate', function(e) {
      		selectRaid(currentProps, e.date);
      	});
      }

      function getLastRaid(lastRaid, includeButton) {
    	  var htmlContent = "";
    	  var containerClass = "";
    	  if (!includeButton) {
    		  containerClass = "-small";
    	  }
    	  if (lastRaid!=null) {
    		  var lastRaidDate = new Date(lastRaid);
    		  htmlContent="<div id=\"badger-info-raid\" class=\"alert alert-success badger-last-raid" + containerClass +" collapsed\"" + 
    		        "data-toggle=\"collapse\" href=\"#collapseDate\" aria-expanded=\"false\" aria-controls=\"collapseDate\">" +
    		          "<div>Last raided <time class=\"timeago\" datetime=\"" + lastRaidDate.toISOString() + "\"></time>" +
    		          "<div id=\"collapseDate\" class=\"collapse hide\" role=\"tabpanel\" aria-labelledby=\"badger-info-raid\" data-parent=\"#badger-info\">" +
        		        "<div class=\"badger-time-badge-container\"><span class=\"badge badge-success badger-time-badge\">" +
        		          lastRaidDate.toLocaleString() +
        		          "</span></div>" +
        		      "</div>" +
    		          "</div>" +
    	              getRaidButtonHtml(includeButton) + "</div>"; 
    	  } else {
    	      htmlContent = "<div id=\"badger-info-raid\" class=\"alert alert-warning badger-no-raid" + containerClass +"\"><div>No raid recorded yet</div>" +
    	          getRaidButtonHtml(includeButton) + "</div>";
    	  }
    	  return htmlContent;
      }
      
      function getRaidButtonHtml(includeButton) {
    	  if (!includeButton) {
    		  return "";
    	  }
    	  return "<div class=\"dropdown badger-info-raid-dropdown\">" +
	        "<button class=\"btn btn-info badger-info-raid-button\" type=\"button\" id=\"raidMenuButton\" data-toggle=\"dropdown\"" +
	        " aria-haspopup=\"true\" aria-expanded=\"false\">" + 
	            "<span class=\"badger-raid-button-container\">" +
	                "<span>Raid</span>" +
	            "</span>" +
	        "</button>" +
	            "<div class=\"dropdown-menu\" aria-labelledby=\"raidMenuButton\">" +
	              "<a id=\"now\" class=\"dropdown-item badger-info-raid-item\" href=\"#\">Now</a>" +
	          "<a id=\"choose\" class=\"dropdown-item badger-info-raid-item\" data-provide=\"datepicker\" href=\"#\">Choose a Date</a>" +
	        "</div>" +
	      "</div>";
      }

      function selectRaid(props, lastRaid) {
    	  props.lastRaid = lastRaid;
          $.ajax({
            type: "PUT",
            contentType: "application/json; charset=utf-8",
            url: "api/gyms/"+props.id,
            data: JSON.stringify(props, ["id", "name", "lat", "lng", "park", "status", "lastRaid"]),
            success: function (data) {
              // Update the UI by removing old raid time and adding new one
              $("#badger-info-raid").remove();
              $("#badger-area-container").after(getLastRaid(data.lastRaid, true));
              registerRaidEvents();
            },
            error: function (result) {
              errorPage("Failed to update last raid", result);
            }
    	  }); 	  
      }

      function resetPercentage() {
    	  var size = 42;
    	  var lineWidth = 5;
    	  var rotate = 0;
    	  // Calculate the percentage
    	  var data = getPercentGold();
    	  var percent = 0;
    	  if (data.total != 0) {
    	      percent = Math.round((data.gold / data.total) * 100);
          }
    	  // Clear previous percentage
    	  $('#badger-gold-percent').html('');
    	  
    	  var el = document.getElementById('badger-gold-percent');
    	  var canvas = document.createElement('canvas');
    	  
    	  // The percentage text
    	  var span = document.createElement('span');
    	  var spanClass = "badger-percentage-text";
    	  if (percent < 10) {
    		  spanClass += " badger-percentage-text-lg";
    	  } else if (percent > 99) {
    		  spanClass += " badger-percentage-text-sm";
    	  } else {
    		  spanClass += " badger-percentage-text-md";
    	  }
    	  span.className = spanClass;
    	  span.textContent = '' + percent + '%';
    	  
    	  // The details of the gold verses total
    	  var detailsSpan = document.createElement('span');
    	  detailsSpan.className = "badger-percentage-details";
    	  detailsSpan.innerHTML = "" + data.gold + "/" + data.total;
    	  
    	  if (typeof(G_vmlCanvasManager) !== 'undefined') {
    	    G_vmlCanvasManager.initElement(canvas);
    	  }

          var ctx = canvas.getContext('2d');
    	  canvas.width = canvas.height = size;

    	  el.appendChild(detailsSpan);
    	  el.appendChild(span);
    	  el.appendChild(canvas);
    	  

    	  ctx.translate(size / 2, size / 2); // change center
    	  ctx.rotate((-1 / 2 + rotate / 180) * Math.PI); // rotate -90 deg

          var radius = (size - lineWidth) / 2;

          var drawCircle = function(color, lineWidth, percent) {
    				percent = Math.min(Math.max(0, percent || 1), 1);
    				ctx.beginPath();
    				ctx.arc(0, 0, radius, 0, Math.PI * 2 * percent, false);
    				ctx.strokeStyle = color;
    		        ctx.lineCap = 'round'; // butt, round or square
    				ctx.lineWidth = lineWidth
    				ctx.stroke();
          };

    	  drawCircle('#efefef', lineWidth, 100 / 100);
    	  if (percent != 0) {
    	      drawCircle('#f0f000', lineWidth, percent / 100);
    	  }
      }

      function getSearchData() {
    	  var searchData = $.map(gymData, function (obj) {
    		  // Only include the gyms in the list of filtered areas
    		  for (var i = 0; i < selectedAreaIds.length; i++) {
    		      if (selectedAreaIds[i]===obj.area.id) {
    		    	  if (!parksOnly || obj.park===true) {
    		              obj.text = obj.name;
    		              return obj;
    		    	  }
    		      }
    		  }
    		  return null;
          });
    	  return searchData;
      }

      function initSearch() {
    	  $("#search").select2({
    		  placeholder: "Search",
    		  width: '100%',
    		  data: getSearchData()
    	  });
    	  $("#search").on("select2:select", function(e) {
    	      map.setCenter({ lat: e.params.data.lat, lng: e.params.data.lng});
    	      google.maps.event.trigger(e.params.data.marker, 'click');
          });
      }

      function resetSearch() {
    	  closeAnyInfoWindows();
    	  $("#search option").remove(); 
    	  $("#search").html("<option></option>");
    	  $("#search").select2({
    		  placeholder: "Search",
    		  width: '100%',
    		  data: getSearchData()
    	  });
    	  $('#search').change();
      }

      function selectBadge(marker, props, status) {
    	  var oldStatus = props.status;
    	  props.status=status;
    	  $.ajax({
            type: "PUT",
            contentType: "application/json; charset=utf-8",
            url: "api/gyms/"+props.id,
            data: JSON.stringify(props, ["id", "name", "lat", "lng", "status", "park"]),
            success: function (data) {
              marker.setIcon(customIcon(props.status));
              $("#infoBadge").removeClass(getBadgeClass(oldStatus));
              $("#infoBadge").addClass(getBadgeClass(props.status));
              resetPercentage();
            },
            error: function (result) {
              errorPage("Failed to update gym data", result);
            }
    	  });
      }

      function closeAnyInfoWindows() {
          if (currentInfoWindow != null) {
		      currentInfoWindow.destroy();
		      currentInfoWindow = null;
		  }
      }

      function getBadgeColor (status) {
    	  if (status==="BASIC") {
    		  return '#b3ffb3';
    	  }
    	  if (status==="BRONZE") {
    		  return '#ffb366';
    	  }
    	  if (status==="SILVER") {
    		  return '#e0e0d1';
    	  }
    	  if (status==="GOLD") {
    		  return '#ffff00';
    	  }
    	  return '#b3daff';
      }

      function customIcon (status) {
    	  var ret = {
    		path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0',
    		fillColor: getBadgeColor(status),
      	    fillOpacity: 1,
      	    strokeColor: '#000',
      	    strokeWeight: 2,
      	    scale: 1
    	  };
    	  return ret;
      }
      
      function getBadgeClass (status) {
    	  if (status==="BASIC") {
    		  return 'badger-badge-basic';
    	  }
    	  else if (status==="BRONZE") {
    		  return 'badger-badge-bronze';
    	  }
    	  else if (status==="SILVER") {
    		  return 'badger-badge-silver';
    	  }
    	  else if (status==="GOLD") {
    		  return 'badger-badge-gold';
    	  }
    	  return 'badger-badge-none';
      }
      
      function getStatusFromId (id) {
    	  if (id==="select-basic")
    		  return "BASIC";
    	  if (id==="select-bronze")
    		  return "BRONZE";
    	  if (id==="select-silver")
    		  return "SILVER";
    	  if (id==="select-gold")
    		  return "GOLD";
    	  return "NONE";
      }
      
      function getDropdownBadgeClass (currentStatus, targetStatus) {
          var classes = "dropdown-item badger-dropdownitem";
    	  if (currentStatus===targetStatus) {
    		  classes+=" badger-dropdownitem-checked";
    	  }
    	  return classes;
      }
      
      function getParkStatus (park) {
    	  if (park) {
    		  return "<span class=\"badge badge-success badger-small-pill-lm\">park</span>";
    	  }
    	  return "";
      }

      function getPercentGold() {
    	  var results = { total: 0, gold: 0 };
    	  for (var i = 0; i < gymData.length; i++) {
    		  for (var j = 0; j < selectedAreaIds.length; j++) {
    			  if (gymData[i].area.id === selectedAreaIds[j]) {
    				  if (!parksOnly || gymData[i].park===true) {
    				      results.total++;
    				      if (gymData[i].status==='GOLD') {
    				          results.gold++;
    			          }
    				  }
    			  }
    		  }
    	  }
    	  return results;
      }

      function errorPage(title, results) {
    	  $("#errorPageTitle").text(title);
    	  $("#errorPageBody").text(results.responseJSON.message);
    	  $('#errorPage').modal('show');
      }
      
      function showReports() {
    	  if (reportTable != null) {
    	      $("#reportsTable").DataTable().destroy();
    	  }
    	  $("#reportsTableBody").html("");
    	  for (var i = 0; i < gymData.length; i++) {
    		  $("#reportsTableBody").append("<tr>" +
    	          "<td>" + gymData[i].name + "</td>" +
    	          "<td>" + 
    	            "<div id=\"infoBadge\" class=\"badger-badge " + getBadgeClass(gymData[i].status) + "\"></div>" +
    	          "</td>" +
    	          
    	          "<td><div id=\"badger-area-container\">" + 
        		    "<div class=\"badge badge-primary badger-small-pill\">" + gymData[i].area.name + "</div></div>" +
        		  "</td><td><div id=\"badger-area-container\">" +
        		      getParkStatus(gymData[i].park) + "</div></td>" + 
        		  "<td>" + getLastRaid(gymData[i].lastRaid, false) + "</td>" +
    	          "</tr>");
    	  }
    	  $("time.timeago").timeago();
    	  reportTable = $("#reportsTable").DataTable({
    	    "autoWidth": true,
    		"scrollY": 300,
    	    "scrollX": true
    	  });
    	  $('#reportsPage').on('shown.bs.modal', function () {
    		  reportTable.columns.adjust().draw();
    	  });
    	  $("#reportsPage").modal('show');
      }

    </script>
  </body>
</html>
